<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="FriendBlackMapper">
 	
	<resultMap id="friendBlackSelectMap" 		type="friendBlack">
		<result property="friendBlackNo" 			column="friend_black_no" 			jdbcType="INTEGER"/>
		<result property="userEmail"					column="user_email" 					jdbcType="VARCHAR" />
		<result property="targetEmail" 				column="target_email" 					jdbcType="VARCHAR" />
		<result property="fbStatus" 						column="f_b_status" 					jdbcType="CHAR" />
		<result property="accStatus" 					column="acc_status" 					jdbcType="CHAR" />
		
		<!-- 아래 추가-->
		<result property="nick" 						column="nick" 									jdbcType="VARCHAR" />
		<result property="profileImg" 				column="profile_img" 						jdbcType="VARCHAR" />
		
	</resultMap>
	
	
	<!-- 본인의 친구 목록조회. 동적쿼리로 만들기 실패..  -->
	<select  id="getFriendList"  parameterType="map"	resultMap="friendBlackSelectMap">
	  	SELECT 
	  	*
	  	FROM (	
	  					SELECT 
	  					inner_table.* , ROWNUM AS row_seq
	  					FROM		(	SELECT 
	  					                   u.nick, u.profile_img
											FROM users u, friend_blacks f 
											<where>
											u.user_email = f.target_email 
											AND f.f_b_status = '1' 
											AND f.acc_status = '2'
											AND f.user_email = #{userEmail} 
											<if test="searchCondition == 0 and searchKeyword !='' ">
											AND u.nick = #{searchKeyword}
											</if>
											</where>
											ORDER BY f.friend_black_no ) inner_table
						WHERE ROWNUM &lt;= #{endRowNum} )
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum} 
	 </select>
	 
	 <!-- 본인의 블랙리스트 목록조회. 동적쿼리로 만들기 실패..  -->
	<select  id="getBlackList"  parameterType="map"	resultMap="friendBlackSelectMap">
	  	SELECT 
	  	*
	  	FROM (	
	  					SELECT 
	  					inner_table.* , ROWNUM AS row_seq
	  					FROM		(	SELECT 
	  					                   u.nick, u.profile_img
											FROM users u, friend_blacks f 
											<where>
											u.user_email = f.target_email 
											AND f.f_b_status = '2' 
											AND f.user_email = #{userEmail} 
											<if test="searchCondition == 0 and searchKeyword !='' ">
											AND u.nick = #{searchKeyword}
											</if>
											</where>
											ORDER BY f.friend_black_no ) inner_table
						WHERE ROWNUM &lt;= #{endRowNum} )
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum} 
	 </select>
	 
	 	<!-- 친구요청을 받은 목록조회 ()-->
	<select  id="getFriendRequestList"  parameterType="map"	resultMap="friendBlackSelectMap">
	  	SELECT 
	  	*
	  	FROM (	
	  					SELECT 
	  					inner_table.* , ROWNUM AS row_seq
	  					FROM		(	SELECT 
	  					                   u.nick, u.profile_img
											FROM users u, friend_blacks f 
											<where>
											u.user_email = f.user_email 
											and f.f_b_status = '1' 
											and f.acc_status = '1'
											and f.target_email = #{targetEmail}
										</where>	
											ORDER BY f.friend_black_no ) inner_table
						WHERE ROWNUM &lt;= #{endRowNum} )
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum} 
	 </select>
	 
	 
	
	<!-- SQL : SELECT ROW Count  토탈 카운트 나오는 방식을 이해 X  -->	 
	 <select  id="getTotalCount"  parameterType="search"	 resultType="int">
	  	SELECT COUNT(*)
	  	FROM(	SELECT u.nick
						FROM users u 
						<if test="searchCondition != null">
							<where>
								<if test="searchCondition == 0 and searchKeyword !='' ">
						 			u.nick = #{searchKeyword}
								</if>
							</where>
						</if> ) countTable						
	 </select>


	  <!-- 친구 등록  //// 친구랑 블랙리스트 등록 합칠수있을꺼같은데... -->
	<insert 	id="addFriend"		parameterType="friendBlack" >
	 	INSERT
		INTO FRIEND_BLACKS
		VALUES	 (seq_friend_black_no.NEXTVAL, #{userEmail : VARCHAR}, #{targetEmail : VARCHAR}, '1', '1')
	 </insert>
	 
	 
	 
	 
	 
	 
	 <!-- 블랙리스트 등록 -->
	<insert 	id="addBlack"		parameterType="friendBlack" >
	 	INSERT
		INTO FRIEND_BLACKS
		VALUES	 (seq_friend_black_no.NEXTVAL, #{userEmail : VARCHAR}, #{targetEmail : VARCHAR}, '2', null)
	 </insert>
	 
	 <!-- 친구 요청 수락 -->
	 <update	id="updateAccStatus"	parameterType="friendBlack" >
	   	UPDATE friend_blacks 
	   	<set>
	   		acc_status = '2'
	   	</set>
	   	WHERE user_email = #{userEmail} and  target_email = #{targetEmail} and f_b_status = '1'
	 </update>
	 
	 <!-- 친구 요청 거절, 친구 삭제 (다시확인)  -->
	 <delete id="deleteFriend">
	   delete from friend_blacks 
	   WHERE user_email = #{userEmail} and  target_email = #{targetEmail} and f_b_status = '1' and acc_status = #{accStatus}
	 </delete>
	 
	 	
	 
</mapper>