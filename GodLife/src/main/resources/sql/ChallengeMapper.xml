<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ChallengeMapper">
 	<resultMap id="ChallengeSelectMap" type="challenge">
		<result property="challengeNo"				column="challenge_no"		jdbcType="NUMERIC" />
		<result property="hostEmail"				column="host_email"			jdbcType="VARCHAR" />
		<result property="challengeTitle"			column="title"				jdbcType="VARCHAR" />
		<result property="challengeThumbnail"		column="thumbnail_img"		jdbcType="VARCHAR" />
		<result property="challengeDetail"			column="detail"				jdbcType="VARCHAR" />
		<result property="challengeRule"			column="rule"				jdbcType="VARCHAR" />
		<result property="challengeCateNo"			column="categ_no"			jdbcType="NUMERIC" />
		<result property="startDate"				column="start_date"			jdbcType="VARCHAR" />
		<result property="endDate"					column="end_date"			jdbcType="VARCHAR" />
		<result property="openRange"				column="open_range"			jdbcType="VARCHAR" />
		<result property="joinPoint"				column="join_point"			jdbcType="NUMERIC" />
		<result property="challengeRegDate"			column="reg_date"			jdbcType="DATE" />
		<result property="challengeStatus"			column="status"				jdbcType="VARCHAR" />
		<result property="joinCount"				column="join_count"			jdbcType="NUMERIC" />
		<result property="totalCertiCount"			column="total_certi_count"	jdbcType="NUMERIC" />
	</resultMap>
 	
 	
 	<!--/////////////////////// Challenges ////////////////////// -->
 	
 	
	
	<!-- ////////// insert //////////// -->
	
	 <insert id="insertChallenge" parameterType="challenge">
	 	
	 	
	 	<selectKey keyProperty="challengeNo" resultType="int" order="BEFORE">  
        	SELECT seq_challenges_challenge_no.nextval FROM dual
     	</selectKey>
	 	
	 	INSERT INTO CHALLENGES
	 				(challenge_no
	 				,host_email
	 				,title
	 				,thumbnail_img
	 				,detail
	 				,rule
	 				,categ_no
	 				,start_date
	 				,end_date
	 				,open_range
	 				,join_point
	 				,status
	 				,reg_date
	 				,TOTAL_CERTI_COUNT	)
					VALUES
					(#{challengeNo}
					,#{hostEmail}
					,#{challengeTitle}
					,#{challengeThumbnailImg}
					,#{challengeDetail}
					,#{challengeRule}
					,#{challengeCateNo}
					,#{startDate}
					,#{endDate}
					,#{openRange}
					,#{joinPoint}
					,#{challengeStatus}
					,SYSDATE
					,#{totalCertiCount}
					)
	 </insert> 
	 
	 <!-- ////////// insert //////////// -->
	 
	 
	 <!-- ////////// select //////////// -->
	 <select id="getChallengeList" resultType="java.util.Map">
			SELECT
			list.*
			FROM
			(
			SELECT
			inv.CHALLENGE_NO,
			inv.HOST_EMAIL,
			inv.TITLE,
			inv.THUMBNAIL_IMG,
			inv.DETAIL,
			inv.RULE,
			inv.CATEG_NO,
			inv.START_DATE,
			inv.END_DATE,
			inv.OPEN_RANGE,
			inv.JOIN_POINT,
			inv.STATUS,
			inv.REG_DATE,
			inv.TOTAL_CERTI_COUNT
			FROM
				(
					SELECT
					NVL(fb.user_email,'0') user_email,
					NVL(fb.target_email,'0') target_email,
					NVL(fb.f_b_status,'0')f_b_status,
				        c.*
					FROM
					friend_blacks fb, challenges c
					WHERE fb.target_email(+) = c.host_email
			)inv
			WHERE NOT inv.user_email = #{user.userEmail}
			AND NOT inv.target_email = #{user.userEmail}
			AND inv.status = '0'
			AND inv.open_range = '0'<!-- 여기까지 전체목록 조회 -->
			UNION
			SELECT
			*
			FROM
			challenges
			WHERE host_email = #{user.userEmail}
			AND status = '0'		<!-- 내가 등록한 챌린지 목록  -->
			UNION
			SELECT
			        c.*
			FROM
			(
				SELECT
				inv.*
				FROM
					(
						SELECT
						*
						FROM
						friend_blacks
						WHERE user_email = #{user.userEmail}
						OR target_email = #{user.userEmail}
					)inv
				WHERE acc_status = '2'
			)outv, challenges c
			WHERE outv.target_email(+) = c.host_email
			AND acc_status = '2'
			AND NOT c.host_email = #{user.userEmail}
			UNION
			SELECT
			        c.*
			FROM
			(
				SELECT
				inv.*
				FROM
					(
						SELECT
						*
						FROM
						friend_blacks
						WHERE user_email = #{user.userEmail}
						OR target_email = #{user.userEmail}
					)inv
				WHERE acc_status = '2'
			)outv, challenges c
			WHERE outv.user_email(+) = c.host_email
			AND acc_status = '2'
			AND NOT c.host_email = #{user.userEmail}  <!-- 친구 가 등록한 챌린지 -->
			)list
			ORDER BY list.challenge_no;
	 
	 
	 </select>
	 <!-- ////////// select //////////// -->
	 
	 
	 <!--/////////////////////// Challenges ////////////////////// -->
	 
	 
	 
	 
	 
	 <!--/////////////////////// CertiCycle ////////////////////// -->
	 
	 
	 <!-- ////////// insert //////////// -->
	 
	 <insert id="insertCertiDay" parameterType="java.util.Map" >
			INSERT into CERTI_CYCLE(CERTI_CYCLE_NO,CERTI_DAY,CHALLENGE_NO,STATUS)
			    SELECT seq_certi_cycle_certi_cycle_no.NEXTVAL, A.* FROM(
    		<foreach item="item" collection="certiCycle" separator="UNION ALL " >
		        select #{item} as CERT_DAY,
		        #{challengeNo} as CHALLENGE_NO,
		        '0' as STATUS
		        from dual
    		</foreach>) A
	</insert>

	 
	 
	 <insert id="insertCertiDate" parameterType="java.util.Map" >
		    INSERT into CERTI_CYCLE(CERTI_CYCLE_NO,CERTI_DATE,CHALLENGE_NO,STATUS)
			    SELECT seq_certi_cycle_certi_cycle_no.NEXTVAL, A.* FROM(
    		<foreach item="item" collection="certiDate" separator="UNION ALL " >
		        select #{item} as CERT_DATE,
		        #{challengeNo} as CHALLENGE_NO,
		        '1' as STATUS 
		        from dual
    		</foreach>) A
	</insert>
	
	<!-- ////////// insert //////////// -->
	
	<!--/////////////////////// CertiCycle ////////////////////// -->
	 	
	 	
	 	
	 	
 	<!--/////////////////////// JoinChallenger ////////////////////// -->
 	
 	
 	<!-- ////////// insert //////////// -->
 	<insert id="insertJoinChallenger" parameterType="challenge">
 		INSERT INTO join_challenger
 					(
 					join_challenger_no
 					,user_email
 					,challenge_no
 					,certi_count
 					,challenge_percent
 					,challenge_reward_point
 					,challenge_reward_flag
 					,status
 					)
				VALUES(
					seq_join_challenger_no.nextval
					,#{hostEmail}
					,#{challengeNo}
					,0
					,0.0
					,0
					,0
					,0
					)
 	</insert>
 	<!-- ////////// insert //////////// -->
 	
 	
 	<!--/////////////////////// JoinChallenger ////////////////////// -->
	 	
	 	
	 
	 
</mapper>